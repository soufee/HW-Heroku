{"version":3,"file":"Validation.js","sourceRoot":"","sources":["src/Validation.ts"],"names":[],"mappings":"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","sourcesContent":["// TODO: Fix dependency cycle\n\nimport type { Binder } from './Binder.js';\nimport type { BinderNode } from './BinderNode.js';\n// eslint-disable-next-line import/no-cycle\nimport { AbstractModel, getBinderNode, NumberModel } from './Models.js';\n// eslint-disable-next-line import/no-cycle\nimport { Required } from './Validators.js';\n\nexport interface ValueError<T> {\n  property: string | AbstractModel<any>;\n  message: string;\n  value: T;\n  validator: Validator<T>;\n}\n\nexport interface ValidationResult {\n  property: string | AbstractModel<any>;\n  message?: string;\n}\n\nexport class ValidationError extends Error {\n  public constructor(public errors: ReadonlyArray<ValueError<any>>) {\n    super(\n      [\n        'There are validation errors in the form.',\n        ...errors.map((e) => `${e.property} - ${e.validator.constructor.name}${e.message ? `: ${e.message}` : ''}`),\n      ].join('\\n - '),\n    );\n    this.name = this.constructor.name;\n  }\n}\n\nexport type ValidationCallback<T> = (\n  value: T,\n  binder: Binder<any, AbstractModel<T>>,\n) =>\n  | boolean\n  | ValidationResult\n  | ReadonlyArray<ValidationResult>\n  | Promise<boolean | ValidationResult | ReadonlyArray<ValidationResult>>;\n\nexport type InterpolateMessageCallback<T> = (\n  message: string,\n  validator: Validator<T>,\n  binderNode: BinderNode<T, AbstractModel<T>>,\n) => string;\n\nexport interface Validator<T> {\n  validate: ValidationCallback<T>;\n  message: string;\n  impliesRequired?: boolean;\n}\n\nexport class ServerValidator implements Validator<any> {\n  public message: string;\n\n  public constructor(message: string) {\n    this.message = message;\n  }\n\n  public validate = () => false;\n}\n\nexport async function runValidator<T>(\n  model: AbstractModel<T>,\n  validator: Validator<T>,\n  interpolateMessageCallback?: InterpolateMessageCallback<T>,\n): Promise<ReadonlyArray<ValueError<T>>> {\n  const binderNode = getBinderNode(model);\n  const { value } = binderNode;\n\n  const interpolateMessage = (message: string) => {\n    if (!interpolateMessageCallback) {\n      return message;\n    }\n    return interpolateMessageCallback(message, validator, binderNode);\n  };\n\n  // If model is not required and value empty, do not run any validator. Except\n  // always validate NumberModel, which has a mandatory builtin validator\n  // to indicate NaN input.\n  if (!getBinderNode(model).required && !new Required().validate(value!) && !(model instanceof NumberModel)) {\n    return [];\n  }\n  return (async () => validator.validate(value!, getBinderNode(model).binder))().then((result) => {\n    if (result === false) {\n      return [\n        { property: getBinderNode(model).name, value, validator, message: interpolateMessage(validator.message) },\n      ];\n    }\n    if (result === true || (Array.isArray(result) && result.length === 0)) {\n      return [];\n    }\n    if (Array.isArray(result)) {\n      return result.map((result2) => ({\n        message: interpolateMessage(validator.message),\n        ...result2,\n        value,\n        validator,\n      }));\n    }\n    return [{ message: interpolateMessage(validator.message), ...result, value, validator }];\n  });\n}\n"]}